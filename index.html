<!doctype html>
<html lang="ja">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•™å®¤ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ²ç¤ºæ¿</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body {
      height: 100%;
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    
    /* é»’æ¿ã®ãƒãƒ§ãƒ¼ã‚¯é¢¨ãƒ†ã‚­ã‚¹ãƒˆ */
    .chalk-text {
      text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.3);
    }
    
    /* æœ¨ç›®èª¿ã®æœº */
    .desk {
      background: linear-gradient(135deg, #d4a574 0%, #c89666 100%);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .desk:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    /* ä»˜ç®‹é¢¨ãƒ¡ãƒ¢ */
    .memo-note {
      background: linear-gradient(135deg, #fef9c3 0%, #fde68a 100%);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* ä¿è­·ã•ã‚ŒãŸæŠ•ç¨¿ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .protected-memo {
      background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
      border: 2px solid #0288d1;
    }
    
    /* è‡ªåˆ†ã®æŠ•ç¨¿ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .own-memo {
      background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%);
      border: 2px solid #3b82f6;
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .modal-backdrop {
      animation: fadeIn 0.2s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* å…¨ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .full-screen-layout {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .classroom-container {
      flex: 1;
      overflow: auto;
    }
    
    /* ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
    .image-preview {
      max-width: 100%;
      max-height: 200px;
      object-fit: contain;
      border-radius: 8px;
      margin-top: 8px;
    }
    
    .desk-image {
      width: 100%;
      height: auto;
      max-height: 100%;
      object-fit: contain;
      border-radius: 4px;
    }
    
    .image-drop-zone {
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background-color: #f7fafc;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .image-drop-zone:hover {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }
    
    .image-drop-zone.drag-over {
      border-color: #3b82f6;
      background-color: #dbeafe;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="full-screen-layout"></div>
  <script>
    // ========================================
    // è¨­å®šã¨ãƒ‡ãƒ¼ã‚¿ç®¡ç†
    // ========================================
    
    const defaultConfig = {
      app_title: "æ•™å®¤ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ²ç¤ºæ¿âœã¾ã‚‹ãƒ«ãƒ¼ãƒ ",
      blackboard_placeholder: "ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒã‚„å•é¡Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...",
      desk_label: "æœº",
      desk_rows: "4",
      desk_columns: "8",
      background_color: "#f0f4f8",
      blackboard_color: "#2d5016",
      desk_color: "#d4a574",
      text_color: "#1f2937",
      button_color: "#3b82f6",
      font_family: "sans-serif",
      font_size: 16
    };

    let allMemos = [];
    let currentPageId = "page-1";
    let isTeacherMode = false;
    let hideStudentPosts = false;
    let currentUserId = null;
    let pastedImageData = null; // ãƒšãƒ¼ã‚¹ãƒˆã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜

    // ========================================
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥æ©Ÿèƒ½
    // ========================================
    
    function getCurrentUserId() {
      if (!currentUserId) {
        currentUserId = localStorage.getItem('classroom_user_id');
        if (!currentUserId) {
          currentUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('classroom_user_id', currentUserId);
        }
      }
      return currentUserId;
    }

    function isPostAuthor(memo) {
      return memo.author_id === getCurrentUserId();
    }

    // ========================================
    // ç”»åƒå‡¦ç†æ©Ÿèƒ½
    // ========================================
    
    // ç”»åƒã‚’æœºã®ã‚µã‚¤ã‚ºã«æœ€é©åŒ–
    function resizeImageForDesk(imageData, maxWidth = 300, maxHeight = 300) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          
          // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ãªãŒã‚‰ãƒªã‚µã‚¤ã‚º
          if (width > height) {
            if (width > maxWidth) {
              height *= maxWidth / width;
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width *= maxHeight / height;
              height = maxHeight;
            }
          }
          
          canvas.width = width;
          canvas.height = height;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          // åœ§ç¸®ã—ã¦Base64ã«å¤‰æ›
          resolve(canvas.toDataURL('image/jpeg', 0.8));
        };
        img.src = imageData;
      });
    }
    
    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ç”»åƒã‚’å–å¾—
    async function handlePaste(event) {
      const items = (event.clipboardData || event.originalEvent.clipboardData).items;
      
      for (let item of items) {
        if (item.type.indexOf('image') !== -1) {
          event.preventDefault();
          const blob = item.getAsFile();
          const reader = new FileReader();
          
          reader.onload = async (e) => {
            const resizedImage = await resizeImageForDesk(e.target.result);
            pastedImageData = resizedImage;
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
            const preview = document.getElementById('image-preview');
            if (preview) {
              preview.src = resizedImage;
              preview.style.display = 'block';
              document.getElementById('image-drop-zone').style.display = 'none';
              document.getElementById('remove-image-btn').style.display = 'inline-block';
            }
            
            showToast("ç”»åƒãŒè²¼ã‚Šä»˜ã‘ã‚‰ã‚Œã¾ã—ãŸï¼ˆCtrl+Vã§è²¼ã‚Šä»˜ã‘ï¼‰");
          };
          
          reader.readAsDataURL(blob);
          break;
        }
      }
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‹ã‚‰ç”»åƒã‚’èª­ã¿è¾¼ã¿
    async function handleFileSelect(file) {
      if (!file || !file.type.startsWith('image/')) {
        showToast("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„", "error");
        return;
      }
      
      const reader = new FileReader();
      reader.onload = async (e) => {
        const resizedImage = await resizeImageForDesk(e.target.result);
        pastedImageData = resizedImage;
        
        const preview = document.getElementById('image-preview');
        if (preview) {
          preview.src = resizedImage;
          preview.style.display = 'block';
          document.getElementById('image-drop-zone').style.display = 'none';
          document.getElementById('remove-image-btn').style.display = 'inline-block';
        }
        
        showToast("ç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ");
      };
      
      reader.readAsDataURL(file);
    }
    
    // ç”»åƒã‚’å‰Šé™¤
    window.removeImage = function() {
      pastedImageData = null;
      const preview = document.getElementById('image-preview');
      if (preview) {
        preview.style.display = 'none';
        preview.src = '';
        document.getElementById('image-drop-zone').style.display = 'block';
        document.getElementById('remove-image-btn').style.display = 'none';
      }
    };

    // ========================================
    // Data SDKåˆæœŸåŒ–
    // ========================================
    
    const dataHandler = {
      onDataChanged(data) {
        allMemos = data;
        hideStudentPosts = getCurrentPostVisibilitySettings();
        renderApp();
      }
    };

    async function initializeDataSdk() {
      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) {
        showToast("ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
      }
    }

    // ========================================
    // Element SDKåˆæœŸåŒ–
    // ========================================
    
    async function initializeElementSdk() {
      if (!window.elementSdk) return;
      
      await window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          const appTitle = document.getElementById('app-title');
          const blackboardTextarea = document.getElementById('blackboard-textarea');
          const body = document.body;
          
          if (appTitle) {
            appTitle.textContent = config.app_title || defaultConfig.app_title;
            appTitle.style.fontFamily = `${config.font_family || defaultConfig.font_family}, sans-serif`;
            appTitle.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 1.5}px`;
            appTitle.style.color = config.text_color || defaultConfig.text_color;
          }
          
          if (blackboardTextarea) {
            blackboardTextarea.placeholder = config.blackboard_placeholder || defaultConfig.blackboard_placeholder;
            blackboardTextarea.style.fontFamily = `${config.font_family || defaultConfig.font_family}, monospace`;
            blackboardTextarea.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 1.125}px`;
          }
          
          if (body) {
            body.style.backgroundColor = config.background_color || defaultConfig.background_color;
          }
          
          const desks = document.querySelectorAll('.desk');
          desks.forEach(desk => {
            desk.style.background = `linear-gradient(135deg, ${config.desk_color || defaultConfig.desk_color} 0%, ${adjustColor(config.desk_color || defaultConfig.desk_color, -10)} 100%)`;
          });
          
          const buttons = document.querySelectorAll('.action-button');
          buttons.forEach(button => {
            button.style.backgroundColor = config.button_color || defaultConfig.button_color;
            button.style.fontFamily = `${config.font_family || defaultConfig.font_family}, sans-serif`;
            button.style.fontSize = `${(config.font_size || defaultConfig.font_size) * 0.875}px`;
          });
          
          const blackboard = document.getElementById('blackboard');
          if (blackboard) {
            blackboard.style.backgroundColor = config.blackboard_color || defaultConfig.blackboard_color;
          }
          
          const allText = document.querySelectorAll('p, span, label, div');
          allText.forEach(el => {
            if (!el.classList.contains('action-button') && !el.id.includes('title')) {
              el.style.fontFamily = `${config.font_family || defaultConfig.font_family}, sans-serif`;
              el.style.fontSize = `${config.font_size || defaultConfig.font_size}px`;
            }
          });
        },
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                if (window.elementSdk) {
                  window.elementSdk.setConfig({ background_color: value });
                }
              }
            },
            {
              get: () => config.blackboard_color || defaultConfig.blackboard_color,
              set: (value) => {
                if (window.elementSdk) {
                  window.elementSdk.setConfig({ blackboard_color: value });
                }
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                if (window.elementSdk) {
                  window.elementSdk.setConfig({ text_color: value });
                }
              }
            },
            {
              get: () => config.button_color || defaultConfig.button_color,
              set: (value) => {
                if (window.elementSdk) {
                  window.elementSdk.setConfig({ button_color: value });
                }
              }
            },
            {
              get: () => config.desk_color || defaultConfig.desk_color,
              set: (value) => {
                if (window.elementSdk) {
                  window.elementSdk.setConfig({ desk_color: value });
                }
              }
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || defaultConfig.font_family,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ font_family: value });
              }
            }
          },
          fontSizeable: {
            get: () => config.font_size || defaultConfig.font_size,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }
        }),
        mapToEditPanelValues: (config) => new Map([
          ["app_title", config.app_title || defaultConfig.app_title],
          ["blackboard_placeholder", config.blackboard_placeholder || defaultConfig.blackboard_placeholder],
          ["desk_label", config.desk_label || defaultConfig.desk_label],
          ["desk_rows", config.desk_rows || defaultConfig.desk_rows],
          ["desk_columns", config.desk_columns || defaultConfig.desk_columns]
        ])
      });
    }

    // ========================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    // ========================================
    
    function adjustColor(color, amount) {
      const num = parseInt(color.replace("#", ""), 16);
      const r = Math.max(0, Math.min(255, (num >> 16) + amount));
      const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
      const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
      return "#" + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
    }

    function convertUrlsToLinks(text, isBlackboard = false) {
      if (!text) return '';
      
      const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+)/gi;
      
      return text.replace(urlRegex, (url) => {
        const href = url.startsWith('www.') ? `https://${url}` : url;
        const linkClass = isBlackboard ? 
          "text-white hover:text-gray-200 underline break-all" : 
          "text-blue-600 hover:text-blue-800 underline break-all";
        return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="${linkClass}" onclick="event.stopPropagation()">${url}</a>`;
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message, type = "success") {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function getConfig() {
      return window.elementSdk?.config || defaultConfig;
    }

    function getCurrentBlackboardContent() {
      const blackboardData = allMemos.find(m => 
        m.page_id === currentPageId && 
        m.content_type === 'blackboard'
      );
      return blackboardData?.blackboard_content || '';
    }

    function getCurrentDeskLayout() {
      const layoutData = allMemos.find(m => 
        m.page_id === currentPageId && 
        m.content_type === 'desk_layout'
      );
      return {
        rows: layoutData?.desk_rows || parseInt(defaultConfig.desk_rows),
        columns: layoutData?.desk_columns || parseInt(defaultConfig.desk_columns)
      };
    }

    // ========================================
    // ãƒ‡ãƒ¼ã‚¿æ“ä½œé–¢æ•°
    // ========================================
    
    async function saveMemo(deskNumber, studentName, memoContent, imageData = null) {
      if (allMemos.length >= 999) {
        showToast("ãƒ¡ãƒ¢ã®ä¸Šé™ï¼ˆ999ä»¶ï¼‰ã«é”ã—ã¾ã—ãŸ", "error");
        return;
      }

      const result = await window.dataSdk.create({
        page_id: currentPageId,
        desk_number: deskNumber,
        student_name: studentName,
        memo_content: memoContent,
        image_data: imageData,
        content_type: "memo",
        is_selected: false,
        author_id: getCurrentUserId(),
        created_at: new Date().toISOString()
      });

      if (result.isOk) {
        showToast("ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
      } else {
        showToast("ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
      }
    }

    async function updateMemo(memo, studentName, memoContent, imageData = null) {
      const result = await window.dataSdk.update({
        ...memo,
        student_name: studentName,
        memo_content: memoContent,
        image_data: imageData !== null ? imageData : memo.image_data
      });

      if (result.isOk) {
        showToast("ãƒ¡ãƒ¢ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
      } else {
        showToast("ãƒ¡ãƒ¢ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
      }
    }

    async function toggleMemoSelection(memo) {
      const result = await window.dataSdk.update({
        ...memo,
        is_selected: !memo.is_selected
      });

      if (result.isOk) {
        showToast(memo.is_selected ? "æŠ•ç¨¿ã®é¸æŠã‚’è§£é™¤ã—ã¾ã—ãŸ" : "æŠ•ç¨¿ã‚’é¸æŠã—ã¾ã—ãŸ");
      } else {
        showToast("æŠ•ç¨¿é¸æŠã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
      }
    }

    async function deleteMemo(memo) {
      const result = await window.dataSdk.delete(memo);

      if (result.isOk) {
        showToast("ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
      } else {
        showToast("ãƒ¡ãƒ¢ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
      }
    }

    async function saveBlackboardContent(content) {
      if (allMemos.length >= 999) {
        showToast("ãƒ‡ãƒ¼ã‚¿ã®ä¸Šé™ï¼ˆ999ä»¶ï¼‰ã«é”ã—ã¾ã—ãŸ", "error");
        return;
      }

      const existingBlackboard = allMemos.find(m => 
        m.page_id === currentPageId && 
        m.content_type === 'blackboard'
      );

      if (existingBlackboard) {
        const result = await window.dataSdk.update({
          ...existingBlackboard,
          blackboard_content: content
        });

        if (result.isOk) {
          showToast("é»’æ¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
        } else {
          showToast("é»’æ¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
        }
      } else {
        const result = await window.dataSdk.create({
          page_id: currentPageId,
          desk_number: 0,
          student_name: "",
          memo_content: "",
          blackboard_content: content,
          content_type: "blackboard",
          created_at: new Date().toISOString()
        });

        if (result.isOk) {
          showToast("é»’æ¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
        } else {
          showToast("é»’æ¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
        }
      }
    }

    async function saveDeskLayout(rows, columns) {
      if (allMemos.length >= 999) {
        showToast("ãƒ‡ãƒ¼ã‚¿ã®ä¸Šé™ï¼ˆ999ä»¶ï¼‰ã«é”ã—ã¾ã—ãŸ", "error");
        return;
      }

      const existingLayout = allMemos.find(m => 
        m.page_id === currentPageId && 
        m.content_type === 'desk_layout'
      );

      if (existingLayout) {
        const result = await window.dataSdk.update({
          ...existingLayout,
          desk_rows: rows,
          desk_columns: columns
        });

        if (result.isOk) {
          showToast("æœºé…ç½®ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
        } else {
          showToast("æœºé…ç½®ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
        }
      } else {
        const result = await window.dataSdk.create({
          page_id: currentPageId,
          desk_number: 0,
          student_name: "",
          memo_content: "",
          desk_rows: rows,
          desk_columns: columns,
          content_type: "desk_layout",
          created_at: new Date().toISOString()
        });

        if (result.isOk) {
          showToast("æœºé…ç½®ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
        } else {
          showToast("æœºé…ç½®ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
        }
      }
    }

    // ========================================
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ç®¡ç†
    // ========================================
    
    function openDeskModal(deskNumber) {
      const existingMemo = allMemos.find(m => m.page_id === currentPageId && m.desk_number === deskNumber);
      
      const isAuthor = existingMemo ? isPostAuthor(existingMemo) : true;
      const isReadOnly = !isTeacherMode && existingMemo && !isAuthor;
      
      // æ—¢å­˜ã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
      pastedImageData = existingMemo?.image_data || null;
      
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
      modal.onclick = (e) => {
        if (e.target === modal) {
          pastedImageData = null;
          closeModal(modal);
        }
      };

      const config = getConfig();
      
      let statusMessage = '';
      let statusColor = '';
      let statusIcon = '';
      
      if (existingMemo) {
        if (isTeacherMode) {
          statusMessage = 'æ•™å¸«ãƒ¢ãƒ¼ãƒ‰ï¼šå…¨ã¦ã®æŠ•ç¨¿ã‚’ç·¨é›†ãƒ»å‰Šé™¤ã§ãã¾ã™';
          statusColor = 'text-green-800';
          statusIcon = 'ğŸ‘¨â€ğŸ«';
        } else if (isAuthor) {
          statusMessage = 'ã‚ãªãŸã®æŠ•ç¨¿ï¼šç·¨é›†ãƒ»å‰Šé™¤ã§ãã¾ã™';
          statusColor = 'text-blue-800';
          statusIcon = 'âœï¸';
        } else {
          statusMessage = 'ä»–ã®ç”Ÿå¾’ã®æŠ•ç¨¿ï¼šèª­ã¿å–ã‚Šå°‚ç”¨ã§ã™';
          statusColor = 'text-orange-800';
          statusIcon = 'ğŸ”’';
        }
      }
      
      modal.innerHTML = `
        <div class="modal-content bg-white rounded-lg shadow-xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.25}px;">${config.desk_label} ${deskNumber}</h3>
            <div class="flex gap-2">
              ${existingMemo && (isTeacherMode || isAuthor) ? `
                <button onclick="handleDeleteMemo('${existingMemo.__backendId}')" 
                        class="action-button px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                        style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                  å‰Šé™¤
                </button>
              ` : ''}
              <button onclick="pastedImageData = null; this.closest('.modal-backdrop').remove()" 
                      class="px-3 py-1 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
                      style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                ${isReadOnly ? 'é–‰ã˜ã‚‹' : 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}
              </button>
              ${!isReadOnly ? `
                <button onclick="handleSaveMemo(${deskNumber}, ${existingMemo ? `'${existingMemo.__backendId}'` : 'null'})" 
                        class="action-button px-3 py-1 text-white rounded-lg transition-colors"
                        style="background-color: ${config.button_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                  ä¿å­˜
                </button>
              ` : ''}
            </div>
          </div>
          
          ${existingMemo && statusMessage ? `
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4">
              <div class="flex items-center gap-2">
                <span class="text-lg">${statusIcon}</span>
                <span class="${statusColor} font-medium text-sm" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                  ${statusMessage}
                </span>
              </div>
            </div>
          ` : ''}
          
          ${isReadOnly ? `
            <!-- èª­ã¿å–ã‚Šå°‚ç”¨è¡¨ç¤º -->
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-2" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">æŠ•ç¨¿è€…</label>
                <div class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg" 
                     style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">
                  ${existingMemo?.student_name || 'ï¼ˆåå‰ãªã—ï¼‰'}
                </div>
              </div>
              
              ${existingMemo?.image_data ? `
                <div>
                  <label class="block text-sm font-medium mb-2" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">ç”»åƒ</label>
                  <img src="${existingMemo.image_data}" class="image-preview" alt="æŠ•ç¨¿ç”»åƒ" onclick="window.open(this.src)" style="cursor: pointer;">
                </div>
              ` : ''}
              
              <div>
                <label class="block text-sm font-medium mb-2" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">ãƒ¡ãƒ¢å†…å®¹</label>
                <div class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg min-h-32 whitespace-pre-wrap" 
                     style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">
                  ${convertUrlsToLinks(escapeHtml(existingMemo?.memo_content || 'ï¼ˆå†…å®¹ãªã—ï¼‰'))}
                </div>
              </div>
            </div>
          ` : `
            <!-- ç·¨é›†å¯èƒ½è¡¨ç¤º -->
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-2" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">åå‰</label>
                <input type="text" id="student-name" value="${existingMemo?.student_name || ''}" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="åå‰ã‚’å…¥åŠ›"
                       style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-2" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                  ç”»åƒ ğŸ“¸ <span class="text-xs text-gray-500">(Ctrl+Vã§è²¼ã‚Šä»˜ã‘ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)</span>
                </label>
                <input type="file" id="image-file-input" accept="image/*" style="display: none;" onchange="handleFileInputChange(this)">
                <div id="image-drop-zone" class="image-drop-zone" onclick="document.getElementById('image-file-input').click()" ${pastedImageData ? 'style="display: none;"' : ''}>
                  <div style="font-size: 48px; margin-bottom: 8px;">ğŸ“·</div>
                  <p style="color: #4a5568; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                    Ctrl+Vã§ç”»åƒã‚’è²¼ã‚Šä»˜ã‘<br>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
                  </p>
                </div>
                <img id="image-preview" class="image-preview" ${pastedImageData ? `src="${pastedImageData}"` : ''} style="${pastedImageData ? '' : 'display: none;'}" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                <button id="remove-image-btn" onclick="removeImage()" 
                        class="mt-2 px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm"
                        style="${pastedImageData ? '' : 'display: none;'}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.75}px;">
                  âŒ ç”»åƒã‚’å‰Šé™¤
                </button>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-2" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">ãƒ¡ãƒ¢</label>
                <textarea id="memo-content" rows="6" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                          placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                          style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">${existingMemo?.memo_content || ''}</textarea>
              </div>
            </div>
          `}
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // ãƒšãƒ¼ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      if (!isReadOnly) {
        modal.addEventListener('paste', handlePaste);
      }
    }

    function closeModal(modal) {
      modal.remove();
    }
    
    window.handleFileInputChange = function(input) {
      if (input.files && input.files[0]) {
        handleFileSelect(input.files[0]);
      }
    };

    window.handleSaveMemo = async function(deskNumber, memoId) {
      const studentName = document.getElementById('student-name').value.trim();
      const memoContent = document.getElementById('memo-content').value.trim();
      
      if (!studentName && !memoContent && !pastedImageData) {
        showToast("åå‰ã€ãƒ¡ãƒ¢ã€ã¾ãŸã¯ç”»åƒã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
        return;
      }
      
      const modal = document.querySelector('.modal-backdrop');
      
      if (memoId) {
        const memo = allMemos.find(m => m.__backendId === memoId);
        if (memo) {
          await updateMemo(memo, studentName, memoContent, pastedImageData);
        }
      } else {
        await saveMemo(deskNumber, studentName, memoContent, pastedImageData);
      }
      
      pastedImageData = null;
      if (modal) modal.remove();
    };

    window.handleDeleteMemo = async function(memoId) {
      const memo = allMemos.find(m => m.__backendId === memoId);
      if (memo) {
        const modal = document.querySelector('.modal-backdrop');
        await deleteMemo(memo);
        pastedImageData = null;
        if (modal) modal.remove();
      }
    };

    window.toggleMemoSelection = async function(memoId) {
      const memo = allMemos.find(m => m.__backendId === memoId);
      if (memo) {
        await toggleMemoSelection(memo);
      }
    };

    function openBlackboardModal() {
      const currentContent = getCurrentBlackboardContent();
      
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
      modal.onclick = (e) => {
        if (e.target === modal) closeModal(modal);
      };

      const config = getConfig();
      
      modal.innerHTML = `
        <div class="modal-content bg-white rounded-lg shadow-xl max-w-2xl w-full p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.25}px;">ğŸ“‹ é»’æ¿ã®ç·¨é›†</h3>
            <button onclick="this.closest('.modal-backdrop').remove()" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">é»’æ¿ã®å†…å®¹</label>
              <textarea id="blackboard-modal-content" rows="8" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        placeholder="${config.blackboard_placeholder}"
                        style="font-family: ${config.font_family}, monospace; font-size: ${config.font_size}px;">${currentContent}</textarea>
            </div>
            
            <div class="flex gap-2 justify-end">
              <button onclick="this.closest('.modal-backdrop').remove()" 
                      class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
                      style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button onclick="handleSaveBlackboard()" 
                      class="action-button px-4 py-2 text-white rounded-lg transition-colors"
                      style="background-color: ${config.button_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                ä¿å­˜
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    window.handleSaveBlackboard = async function() {
      const content = document.getElementById('blackboard-modal-content').value;
      const modal = document.querySelector('.modal-backdrop');
      
      await saveBlackboardContent(content);
      
      if (modal) modal.remove();
    };

    function showResetConfirmModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
      modal.onclick = (e) => {
        if (e.target === modal) closeModal(modal);
      };

      const config = getConfig();
      
      modal.innerHTML = `
        <div class="modal-content bg-white rounded-lg shadow-xl max-w-md w-full p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-red-600" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.25}px;">âš ï¸ å…¨æŠ•ç¨¿ãƒªã‚»ãƒƒãƒˆç¢ºèª</h3>
            <button onclick="this.closest('.modal-backdrop').remove()" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
          </div>
          
          <div class="space-y-4">
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
              <p class="text-red-800" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">
                <strong>æ³¨æ„ï¼š</strong>ã“ã®æ“ä½œã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ï¼š
              </p>
              <ul class="mt-2 text-red-700 list-disc list-inside" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                <li>å…¨ãƒšãƒ¼ã‚¸ã®ç”Ÿå¾’ãƒ¡ãƒ¢</li>
                <li>é»’æ¿ã®å†…å®¹</li>
                <li>æœºé…ç½®è¨­å®š</li>
              </ul>
              <p class="mt-2 text-red-800 font-semibold" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
              </p>
            </div>
            
            <div class="flex gap-2 justify-end">
              <button onclick="this.closest('.modal-backdrop').remove()" 
                      class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
                      style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button onclick="handleResetAllData()" 
                      class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                      style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                ğŸ—‘ï¸ å…¨ã¦å‰Šé™¤ã™ã‚‹
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    window.handleResetAllData = async function() {
      const modal = document.querySelector('.modal-backdrop');
      
      const deletePromises = allMemos.map(memo => window.dataSdk.delete(memo));
      
      try {
        const results = await Promise.all(deletePromises);
        const failedDeletes = results.filter(result => !result.isOk);
        
        if (failedDeletes.length === 0) {
          showToast("å…¨ã¦ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
        } else {
          showToast(`${failedDeletes.length}ä»¶ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ`, "error");
        }
      } catch (error) {
        showToast("å‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "error");
      }
      
      if (modal) modal.remove();
    };

    window.showResetConfirmModal = showResetConfirmModal;

    // ========================================
    // æŠ•ç¨¿è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    // ========================================
    
    async function savePostVisibilitySettings(isHidden) {
      if (allMemos.length >= 999) {
        showToast("ãƒ‡ãƒ¼ã‚¿ã®ä¸Šé™ï¼ˆ999ä»¶ï¼‰ã«é”ã—ã¾ã—ãŸ", "error");
        return;
      }

      const existingSettings = allMemos.find(m => 
        m.page_id === currentPageId && 
        m.content_type === 'post_visibility'
      );

      if (existingSettings) {
        const result = await window.dataSdk.update({
          ...existingSettings,
          hide_student_posts: isHidden
        });

        if (!result.isOk) {
          showToast("è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
        }
      } else {
        const result = await window.dataSdk.create({
          page_id: currentPageId,
          desk_number: 0,
          student_name: "",
          memo_content: "",
          hide_student_posts: isHidden,
          content_type: "post_visibility",
          created_at: new Date().toISOString()
        });

        if (!result.isOk) {
          showToast("è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
        }
      }
    }

    function getCurrentPostVisibilitySettings() {
      const visibilityData = allMemos.find(m => 
        m.page_id === currentPageId && 
        m.content_type === 'post_visibility'
      );
      return visibilityData?.hide_student_posts || false;
    }
    
    window.togglePostVisibility = async function() {
      hideStudentPosts = !hideStudentPosts;
      await savePostVisibilitySettings(hideStudentPosts);
      renderApp();
      
      if (hideStudentPosts) {
        showToast("æŠ•ç¨¿ã‚’éš ã—ã¾ã—ãŸã€‚ğŸ‘€/ğŸ˜ã‚¢ã‚¤ã‚³ãƒ³ã§å€‹åˆ¥ã«è¡¨ç¤ºåˆ¶å¾¡ã§ãã¾ã™");
      } else {
        showToast("æŠ•ç¨¿ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ");
      }
    };

    window.toggleIndividualDeskVisibility = async function(memoId) {
      const memo = allMemos.find(m => m.__backendId === memoId);
      if (!memo) return;

      const result = await window.dataSdk.update({
        ...memo,
        is_selected: !memo.is_selected
      });

      if (result.isOk) {
        const action = memo.is_selected ? "éè¡¨ç¤º" : "è¡¨ç¤º";
        showToast(`æœº${memo.desk_number}ã®æŠ•ç¨¿ã‚’ç”Ÿå¾’ã«${action}ã«ã—ã¾ã—ãŸ`);
      } else {
        showToast("è¡¨ç¤ºè¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
      }
    };

    // ========================================
    // ãƒšãƒ¼ã‚¸ç®¡ç†
    // ========================================
    
    function goToPreviousPage() {
      const pageNum = parseInt(currentPageId.split('-')[1]);
      if (pageNum > 1) {
        currentPageId = `page-${pageNum - 1}`;
        hideStudentPosts = getCurrentPostVisibilitySettings();
        renderApp();
      }
    }

    function goToNextPage() {
      const pageNum = parseInt(currentPageId.split('-')[1]);
      currentPageId = `page-${pageNum + 1}`;
      hideStudentPosts = getCurrentPostVisibilitySettings();
      renderApp();
    }

    // ========================================
    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    // ========================================
    
    function renderApp() {
      const config = getConfig();
      const app = document.getElementById('app');
      const currentPageMemos = allMemos.filter(m => 
        m.page_id === currentPageId && 
        (m.content_type === 'memo' || (!m.content_type && m.desk_number > 0))
      );
      const pageNum = parseInt(currentPageId.split('-')[1]);
      const currentLayout = getCurrentDeskLayout();
      
      app.innerHTML = `
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-white shadow-sm px-6 py-3 flex-shrink-0">
          <div class="flex items-center justify-between">
            <h1 id="app-title" class="text-2xl font-bold" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.5}px;">
              ${config.app_title}
            </h1>
            <div class="flex items-center gap-4">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" ${isTeacherMode ? 'checked' : ''} onchange="toggleTeacherMode(this)" class="w-4 h-4">
                <span style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">æ•™å¸«ãƒ¢ãƒ¼ãƒ‰</span>
              </label>
              ${isTeacherMode ? `
                <div class="flex items-center gap-4">
                  <div class="flex items-center gap-2">
                    <span style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">æœºé…ç½®:</span>
                    <input type="number" min="1" max="10" value="${currentLayout.rows}" 
                           id="desk-rows-input"
                           class="w-16 px-2 py-1 border border-gray-300 rounded text-center"
                           style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                    <span style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">Ã—</span>
                    <input type="number" min="1" max="10" value="${currentLayout.columns}" 
                           id="desk-columns-input"
                           class="w-16 px-2 py-1 border border-gray-300 rounded text-center"
                           style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                    <button onclick="applyDeskLayout()" 
                            class="action-button px-3 py-1 text-white rounded-lg transition-colors"
                            style="background-color: ${config.button_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                      å®Ÿè¡Œ
                    </button>
                  </div>
                  <button onclick="togglePostVisibility()" 
                          class="px-3 py-1 text-white rounded-lg transition-colors"
                          style="background-color: ${hideStudentPosts ? '#f59e0b' : '#10b981'}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                    ${hideStudentPosts ? 'ğŸ‘ï¸ æŠ•ç¨¿ã‚’è¡¨ç¤º' : 'ğŸ™ˆ æŠ•ç¨¿ã‚’éš ã™'}
                  </button>
                  <button onclick="showResetConfirmModal()" 
                          class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                          style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                    ğŸ—‘ï¸ å…¨æŠ•ç¨¿ãƒªã‚»ãƒƒãƒˆ
                  </button>
                </div>
              ` : ''}
            </div>
          </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="flex-1 flex flex-col overflow-hidden">
          <!-- é»’æ¿ã‚¨ãƒªã‚¢ -->
          <div class="px-6 py-2 flex-shrink-0">
            <div id="blackboard" class="rounded-lg shadow-lg p-3 cursor-pointer" style="background-color: ${config.blackboard_color};" ${isTeacherMode ? 'onclick="openBlackboardModal()"' : ''}>
              <div class="flex items-center justify-between mb-1">
                <h2 class="text-lg font-bold text-white chalk-text" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.125}px;">ğŸ“‹ é»’æ¿</h2>
                ${isTeacherMode ? `<span class="text-white text-sm opacity-75" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.75}px;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›†</span>` : ''}
              </div>
              <div class="text-white chalk-text p-2 min-h-8 whitespace-pre-wrap" style="font-family: ${config.font_family}, monospace; font-size: ${config.font_size * 1.5}px; line-height: 1.4;">
                ${convertUrlsToLinks(getCurrentBlackboardContent(), true) || 'ï¼ˆãƒ†ãƒ¼ãƒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰'}
              </div>
            </div>
          </div>

          <!-- æ•™å®¤ã‚¨ãƒªã‚¢ -->
          <div class="flex-1 px-6 pb-3 overflow-hidden">
            <div class="bg-white rounded-lg shadow-lg h-full flex flex-col">
              <!-- æ•™å®¤ãƒ˜ãƒƒãƒ€ãƒ¼ -->
              <div class="px-6 py-3 border-b flex items-center justify-between flex-shrink-0">
                <h2 class="text-lg font-bold" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.125}px;">ğŸ« æ•™å®¤ï¼ˆãƒšãƒ¼ã‚¸ ${pageNum}ï¼‰</h2>
                <div class="flex items-center gap-4">
                  <button onclick="goToPreviousPage()" 
                          ${pageNum === 1 ? 'disabled' : ''}
                          class="action-button px-3 py-1 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                          style="background-color: ${config.button_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                    â† å‰
                  </button>
                  <span class="font-medium" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                    ${pageNum}
                  </span>
                  <button onclick="goToNextPage()" 
                          class="action-button px-3 py-1 text-white rounded-lg transition-colors"
                          style="background-color: ${config.button_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                    æ¬¡ â†’
                  </button>
                </div>
              </div>
              
              <!-- æœºã‚°ãƒªãƒƒãƒ‰ -->
              <div class="classroom-container p-4">
                <div class="grid gap-2 h-full" style="grid-template-columns: repeat(${currentLayout.columns}, 1fr); grid-template-rows: repeat(${currentLayout.rows}, 1fr);">
                  ${Array.from({length: currentLayout.rows * currentLayout.columns}, (_, i) => {
                    const rows = currentLayout.rows;
                    const cols = currentLayout.columns;
                    const row = Math.floor(i / cols);
                    const col = i % cols;
                    const deskNumber = (cols - 1 - col) * rows + row + 1;
                    const memo = currentPageMemos.find(m => m.desk_number === deskNumber);
                    
                    let shouldShowContent = false;
                    let deskColor = config.desk_color;
                    let clickAction = `openDeskModal(${deskNumber})`;
                    let showVisibilityIcon = false;
                    let visibilityIcon = '';
                    let iconClickAction = '';
                    let isProtected = false;
                    let isOwnPost = false;
                    
                    if (memo) {
                      isOwnPost = isPostAuthor(memo);
                      
                      if (isTeacherMode) {
                        shouldShowContent = true;
                        showVisibilityIcon = hideStudentPosts;
                        
                        if (hideStudentPosts) {
                          if (memo.is_selected) {
                            deskColor = '#3b82f6';
                            visibilityIcon = 'ğŸ‘€';
                            iconClickAction = `toggleIndividualDeskVisibility('${memo.__backendId}')`;
                          } else {
                            deskColor = '#f59e0b';
                            visibilityIcon = 'ğŸ˜';
                            iconClickAction = `toggleIndividualDeskVisibility('${memo.__backendId}')`;
                          }
                        } else {
                          deskColor = '#3b82f6';
                        }
                      } else {
                        if (isOwnPost) {
                          shouldShowContent = true;
                          deskColor = '#3b82f6';
                        } else {
                          isProtected = true;
                          
                          if (hideStudentPosts) {
                            if (memo.is_selected) {
                              shouldShowContent = true;
                              deskColor = '#0288d1';
                            } else {
                              shouldShowContent = false;
                              deskColor = '#f59e0b';
                            }
                          } else {
                            shouldShowContent = true;
                            deskColor = '#0288d1';
                          }
                        }
                      }
                    }
                    
                    return `
                      <div onclick="${clickAction}" 
                           class="desk rounded-lg cursor-pointer relative min-h-0"
                           style="background: linear-gradient(135deg, ${deskColor} 0%, ${adjustColor(deskColor, -10)} 100%);">
                        ${memo ? `
                          ${shouldShowContent ? `
                            <div class="memo-note rounded px-2 py-2 h-full overflow-hidden flex flex-col relative ${isProtected ? 'protected-memo' : (isOwnPost ? 'own-memo' : '')}" style="background: ${isProtected ? 'linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%)' : (isOwnPost ? 'linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%)' : 'linear-gradient(135deg, #fef9c3 0%, #fde68a 100%)')};">
                              ${showVisibilityIcon ? `
                                <div class="absolute top-1 right-1 cursor-pointer text-lg hover:scale-110 transition-transform z-10" 
                                     onclick="event.stopPropagation(); ${iconClickAction}" 
                                     title="${memo.is_selected ? 'ç”Ÿå¾’ã«éè¡¨ç¤ºã«ã™ã‚‹' : 'ç”Ÿå¾’ã«è¡¨ç¤ºã™ã‚‹'}">
                                  ${visibilityIcon}
                                </div>
                              ` : ''}
                              ${isProtected ? `
                                <div class="absolute top-1 left-1 text-blue-600 text-sm" title="ä»–ã®ç”Ÿå¾’ã®æŠ•ç¨¿ï¼ˆä¿è­·ä¸­ï¼‰">ğŸ”’</div>
                              ` : (isOwnPost ? `
                                <div class="absolute top-1 left-1 text-blue-600 text-sm" title="ã‚ãªãŸã®æŠ•ç¨¿">âœï¸</div>
                              ` : '')}
                              ${memo.image_data ? `
                                <div class="mb-1">
                                  <img src="${memo.image_data}" class="desk-image" alt="æŠ•ç¨¿ç”»åƒ">
                                </div>
                              ` : ''}
                              <div class="text-xs font-semibold mb-1 ${(isProtected || isOwnPost) ? 'mt-4' : ''}" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.75}px;">
                                ${memo.student_name}
                              </div>
                              ${memo.memo_content ? `
                                <div class="text-xs flex-1 overflow-hidden" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.75}px; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: ${memo.image_data ? '4' : '12'}; -webkit-box-orient: vertical;">
                                  ${convertUrlsToLinks(escapeHtml(memo.memo_content))}
                                </div>
                              ` : ''}
                            </div>
                          ` : `
                            <div class="h-full flex flex-col items-center justify-center text-white text-opacity-90 text-xs text-center" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.75}px;">
                              <div class="text-2xl mb-1">ğŸ“</div>
                              <div class="font-semibold">æœº ${deskNumber}</div>
                              <div class="text-xs opacity-75">${isTeacherMode && hideStudentPosts ? 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ' : 'æŠ•ç¨¿ã‚ã‚Šï¼ˆä¿è­·ä¸­ï¼‰'}</div>
                            </div>
                          `}
                        ` : `
                          <div class="h-full flex flex-col items-center justify-center text-white text-opacity-60 text-xs text-center" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.75}px;">
                            <div class="font-semibold" style="font-size: ${config.font_size * 1.5}px;">æœº ${deskNumber}</div>
                            <div>ã‚¯ãƒªãƒƒã‚¯ã—ã¦å…¥åŠ›</div>
                          </div>
                        `}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ========================================
    // æ•™å¸«ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
    // ========================================
    
    window.toggleTeacherMode = function(checkbox) {
      if (checkbox.checked) {
        showPasswordModal(checkbox);
      } else {
        isTeacherMode = false;
        renderApp();
      }
    };

    function showPasswordModal(checkbox) {
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
      modal.onclick = (e) => {
        if (e.target === modal) {
          checkbox.checked = false;
          closeModal(modal);
        }
      };

      const config = getConfig();
      
      modal.innerHTML = `
        <div class="modal-content bg-white rounded-lg shadow-xl max-w-md w-full p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.25}px;">ğŸ”’ æ•™å¸«ãƒ¢ãƒ¼ãƒ‰èªè¨¼</h3>
            <button onclick="handlePasswordCancel()" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
          </div>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
              <input type="password" id="teacher-password" 
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                     style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                     onkeypress="if(event.key==='Enter') handlePasswordSubmit()">
            </div>
            
            <div class="flex gap-2 justify-end">
              <button onclick="handlePasswordCancel()" 
                      class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
                      style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button onclick="handlePasswordSubmit()" 
                      class="action-button px-4 py-2 text-white rounded-lg transition-colors"
                      style="background-color: ${config.button_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                ç¢ºèª
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      setTimeout(() => {
        const passwordInput = document.getElementById('teacher-password');
        if (passwordInput) passwordInput.focus();
      }, 100);
    }

    window.handlePasswordSubmit = function() {
      const passwordInput = document.getElementById('teacher-password');
      const modal = document.querySelector('.modal-backdrop');
      const checkbox = document.querySelector('input[type="checkbox"]');
      
      if (passwordInput.value === 'teacher') {
        isTeacherMode = true;
        showToast("æ•™å¸«ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ");
        if (modal) modal.remove();
        renderApp();
      } else {
        showToast("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™", "error");
        passwordInput.value = '';
        passwordInput.focus();
        checkbox.checked = false;
      }
    };

    window.handlePasswordCancel = function() {
      const modal = document.querySelector('.modal-backdrop');
      const checkbox = document.querySelector('input[type="checkbox"]');
      
      checkbox.checked = false;
      if (modal) modal.remove();
    };

    // ========================================
    // æœºé…ç½®ç®¡ç†
    // ========================================
    
    window.applyDeskLayout = async function() {
      const rowsInput = document.getElementById('desk-rows-input');
      const columnsInput = document.getElementById('desk-columns-input');
      
      if (!rowsInput || !columnsInput) {
        showToast("å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "error");
        return;
      }
      
      const rows = parseInt(rowsInput.value);
      const columns = parseInt(columnsInput.value);
      
      if (isNaN(rows) || isNaN(columns)) {
        showToast("æœ‰åŠ¹ãªæ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
        return;
      }
      
      if (rows >= 1 && rows <= 10 && columns >= 1 && columns <= 10) {
        await saveDeskLayout(rows, columns);
        
        if (window.elementSdk && window.elementSdk.setConfig) {
          window.elementSdk.setConfig({ 
            desk_rows: rows.toString(),
            desk_columns: columns.toString()
          });
        }
      } else {
        showToast("è¡Œæ•°ã¨åˆ—æ•°ã¯1ã€œ10ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
      }
    };

    // ========================================
    // åˆæœŸåŒ–
    // ========================================
    
    async function init() {
      getCurrentUserId();
      
      await initializeDataSdk();
      await initializeElementSdk();
      renderApp();
    }

    init();
  </script>
 </body>
</html>
